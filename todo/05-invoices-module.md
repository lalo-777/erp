# Invoices Module

## Phase Status: Complete (7/7)

## Backend Status
âœ… COMPLETE - All endpoints implemented
- `D:\erp\servidor\backend\src\controllers\invoices.controller.ts`
- `D:\erp\servidor\backend\src\routes\invoices.routes.ts`

Just need to ensure routes are added to server.ts

## Tasks

### 1. Verify Backend Integration
- [x] Check `D:\erp\servidor\backend\src\server.ts` includes invoice routes
- [x] Add if missing: `app.use('/api/invoices', invoiceRoutes)`
- [x] Test endpoints with curl or Postman
- [x] Verify auto-generation of invoice numbers works

### 2. Invoice Service
**File:** `D:\erp\servidor\erp\src\app\services\invoice.service.ts`

- [x] Implement `getAllInvoices(page, limit, filters)`
- [x] Implement `getInvoiceById(id)`
- [x] Implement `createInvoice(data)`
- [x] Implement `updateInvoice(id, data)`
- [x] Implement `deleteInvoice(id)`
- [x] Implement `getInvoiceStats()`
- [x] Implement `getInvoiceHistory(id)` - audit log
- [x] Implement `getInvoicesByCustomer(customerId)`

### 3. Invoice Models
**File:** `D:\erp\servidor\erp\src\app\models\invoice.model.ts`

- [x] Define `Invoice` interface
- [x] Define `InvoiceItem` interface
- [x] Define `InvoiceListItem` interface
- [x] Define `CreateInvoiceRequest` interface
- [x] Define `InvoiceStats` interface
- [x] Define `InvoiceHistoryEntry` interface
- [x] Define `InvoiceFilters` interface

### 4. Invoices Dashboard
**File:** `D:\erp\servidor\erp\src\app\pages\invoices\dashboard\invoices-dashboard.component.ts`

- [x] Create signals: `invoices`, `stats`, `isLoading`, `filters`
- [x] Load invoices with pagination
- [x] Load stats (total, paid, pending, overdue, amount)
- [x] Implement search functionality
- [x] Implement filters (status, customer, date range, type)
- [x] Implement pagination
- [x] Add "Nueva Factura" button
- [x] Handle view/edit/delete actions

**HTML:**
- [x] Add stats cards at top (4 cards)
- [x] Add filter section (status, customer, dates)
- [x] Use DataTable component
- [x] Add status badges (paid=success, pending=warning, overdue=danger)
- [x] Show invoice number, customer, amount, date, status

### 5. New Invoice Modal
**File:** `D:\erp\servidor\erp\src\app\components\new-invoice-modal\new-invoice-modal.component.ts`

- [x] Create reactive form with FormBuilder
- [x] Add customer autocomplete dropdown
- [x] Add invoice type dropdown (from catalog service)
- [x] Add issue date picker
- [x] Add due date picker
- [x] Add line items array (FormArray)
- [x] Add "Add Item" button
- [x] Add "Remove Item" button per row
- [x] Calculate subtotal, tax, total in real-time
- [x] Implement submit with loading state
- [x] Add validation (customer required, at least one item, amounts valid)
- [x] Show success toast on create
- [x] Emit event to refresh list

**Line Item Fields:**
- [x] description (required)
- [x] quantity (required, min 1)
- [x] unit_price (required, min 0)
- [x] tax_rate (default 16%)
- [x] line_total (calculated)

### 6. Invoice Tracking Page
**File:** `D:\erp\servidor\erp\src\app\pages\invoices\tracking\invoice-tracking.component.ts`

- [x] Get invoice ID from route
- [x] Load invoice details
- [x] Load audit history
- [x] Display invoice header (number, customer, dates, status, amounts)
- [x] Display line items table
- [x] Display payment history section
- [x] Display audit log section (changes over time)
- [x] Add action buttons (Edit, Delete, Download PDF, Record Payment)
- [x] Implement edit (open modal with data)
- [x] Implement delete (confirm dialog)

**HTML:**
- [x] Add breadcrumb navigation
- [x] Create card layout for sections
- [x] Style status badge prominently
- [x] Format currency properly
- [x] Show "Pagada" banner if fully paid

### 7. Integration Testing
- [x] Test create invoice with multiple items
- [x] Test edit invoice
- [x] Test delete invoice
- [x] Test filters (status, customer, date)
- [x] Test pagination
- [x] Test search
- [x] Test calculations (subtotal, tax, total)
- [x] Test validation errors
- [x] Test audit history display
- [x] Test navigation between dashboard and tracking

## Business Logic

**Invoice Number:** Auto-generated by backend (INV-000001, INV-000002, etc.)

**Status Values:**
- pending (amarillo/warning)
- paid (verde/success)
- overdue (rojo/danger)
- cancelled (gris/secondary)

**Calculations:**
```
line_total = quantity * unit_price
line_tax = line_total * (tax_rate / 100)
subtotal = sum(all line_total)
total_tax = sum(all line_tax)
total = subtotal + total_tax
```

**Overdue Logic:**
If `status = pending` AND `due_date < today`, show as overdue

## Notes

- Backend already has audit triggers for invoices_log
- Use audit history to show "who changed what when"
- Customer dropdown should search/filter as user types
- Invoice type comes from `cat_invoice_types` catalog
- Future: PDF generation, email sending, payment recording
