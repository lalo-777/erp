# Invoices Module

## Phase Status: Not Started (0/7)

## Backend Status
âœ… COMPLETE - All endpoints implemented
- `D:\erp\servidor\backend\src\controllers\invoices.controller.ts`
- `D:\erp\servidor\backend\src\routes\invoices.routes.ts`

Just need to ensure routes are added to server.ts

## Tasks

### 1. Verify Backend Integration
- [ ] Check `D:\erp\servidor\backend\src\server.ts` includes invoice routes
- [ ] Add if missing: `app.use('/api/invoices', invoiceRoutes)`
- [ ] Test endpoints with curl or Postman
- [ ] Verify auto-generation of invoice numbers works

### 2. Invoice Service
**File:** `D:\erp\servidor\erp\src\app\services\invoice.service.ts`

- [ ] Implement `getAllInvoices(page, limit, filters)`
- [ ] Implement `getInvoiceById(id)`
- [ ] Implement `createInvoice(data)`
- [ ] Implement `updateInvoice(id, data)`
- [ ] Implement `deleteInvoice(id)`
- [ ] Implement `getInvoiceStats()`
- [ ] Implement `getInvoiceHistory(id)` - audit log
- [ ] Implement `getInvoicesByCustomer(customerId)`

### 3. Invoice Models
**File:** `D:\erp\servidor\erp\src\app\models\invoice.model.ts`

- [ ] Define `Invoice` interface
- [ ] Define `InvoiceItem` interface
- [ ] Define `InvoiceListItem` interface
- [ ] Define `CreateInvoiceRequest` interface
- [ ] Define `InvoiceStats` interface
- [ ] Define `InvoiceHistoryEntry` interface
- [ ] Define `InvoiceFilters` interface

### 4. Invoices Dashboard
**File:** `D:\erp\servidor\erp\src\app\pages\invoices\dashboard\invoices-dashboard.component.ts`

- [ ] Create signals: `invoices`, `stats`, `isLoading`, `filters`
- [ ] Load invoices with pagination
- [ ] Load stats (total, paid, pending, overdue, amount)
- [ ] Implement search functionality
- [ ] Implement filters (status, customer, date range, type)
- [ ] Implement pagination
- [ ] Add "Nueva Factura" button
- [ ] Handle view/edit/delete actions

**HTML:**
- [ ] Add stats cards at top (4 cards)
- [ ] Add filter section (status, customer, dates)
- [ ] Use DataTable component
- [ ] Add status badges (paid=success, pending=warning, overdue=danger)
- [ ] Show invoice number, customer, amount, date, status

### 5. New Invoice Modal
**File:** `D:\erp\servidor\erp\src\app\components\new-invoice-modal\new-invoice-modal.component.ts`

- [ ] Create reactive form with FormBuilder
- [ ] Add customer autocomplete dropdown
- [ ] Add invoice type dropdown (from catalog service)
- [ ] Add issue date picker
- [ ] Add due date picker
- [ ] Add line items array (FormArray)
- [ ] Add "Add Item" button
- [ ] Add "Remove Item" button per row
- [ ] Calculate subtotal, tax, total in real-time
- [ ] Implement submit with loading state
- [ ] Add validation (customer required, at least one item, amounts valid)
- [ ] Show success toast on create
- [ ] Emit event to refresh list

**Line Item Fields:**
- description (required)
- quantity (required, min 1)
- unit_price (required, min 0)
- tax_rate (default 16%)
- line_total (calculated)

### 6. Invoice Tracking Page
**File:** `D:\erp\servidor\erp\src\app\pages\invoices\tracking\invoice-tracking.component.ts`

- [ ] Get invoice ID from route
- [ ] Load invoice details
- [ ] Load audit history
- [ ] Display invoice header (number, customer, dates, status, amounts)
- [ ] Display line items table
- [ ] Display payment history section
- [ ] Display audit log section (changes over time)
- [ ] Add action buttons (Edit, Delete, Download PDF, Record Payment)
- [ ] Implement edit (open modal with data)
- [ ] Implement delete (confirm dialog)

**HTML:**
- [ ] Add breadcrumb navigation
- [ ] Create card layout for sections
- [ ] Style status badge prominently
- [ ] Format currency properly
- [ ] Show "Pagada" banner if fully paid

### 7. Integration Testing
- [ ] Test create invoice with multiple items
- [ ] Test edit invoice
- [ ] Test delete invoice
- [ ] Test filters (status, customer, date)
- [ ] Test pagination
- [ ] Test search
- [ ] Test calculations (subtotal, tax, total)
- [ ] Test validation errors
- [ ] Test audit history display
- [ ] Test navigation between dashboard and tracking

## Business Logic

**Invoice Number:** Auto-generated by backend (INV-000001, INV-000002, etc.)

**Status Values:**
- pending (amarillo/warning)
- paid (verde/success)
- overdue (rojo/danger)
- cancelled (gris/secondary)

**Calculations:**
```
line_total = quantity * unit_price
line_tax = line_total * (tax_rate / 100)
subtotal = sum(all line_total)
total_tax = sum(all line_tax)
total = subtotal + total_tax
```

**Overdue Logic:**
If `status = pending` AND `due_date < today`, show as overdue

## Notes

- Backend already has audit triggers for invoices_log
- Use audit history to show "who changed what when"
- Customer dropdown should search/filter as user types
- Invoice type comes from `cat_invoice_types` catalog
- Future: PDF generation, email sending, payment recording
