<div
  class="modal fade"
  id="userModal"
  tabindex="-1"
  aria-labelledby="userModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalLabel">{{ modalTitle() }}</h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          @if (isLoading()) {
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
          } @else {
            @if (error()) {
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error() }}
                <button type="button" class="btn-close" (click)="error.set(null)"></button>
              </div>
            }

            <div class="row">
              <!-- User Information -->
              <div class="col-12 mb-3">
                <h6 class="text-muted mb-3">Información del Usuario</h6>
              </div>

              <div class="col-md-6 mb-3">
                <label for="username" class="form-label"
                  >Nombre de Usuario <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="username"
                  formControlName="username"
                  [class.is-invalid]="isFieldInvalid('username')"
                />
                @if (isFieldInvalid('username')) {
                  <div class="invalid-feedback">{{ getFieldError('username') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label for="lastname" class="form-label"
                  >Apellido <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="lastname"
                  formControlName="lastname"
                  [class.is-invalid]="isFieldInvalid('lastname')"
                />
                @if (isFieldInvalid('lastname')) {
                  <div class="invalid-feedback">{{ getFieldError('lastname') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label for="email" class="form-label"
                  >Email <span class="text-danger">*</span></label
                >
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  [class.is-invalid]="isFieldInvalid('email')"
                />
                @if (isFieldInvalid('email')) {
                  <div class="invalid-feedback">{{ getFieldError('email') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label for="usr_password" class="form-label">
                  Contraseña
                  @if (!isEditMode()) {
                    <span class="text-danger">*</span>
                  }
                  @if (isEditMode()) {
                    <small class="text-muted">(dejar en blanco para no cambiar)</small>
                  }
                </label>
                <input
                  type="password"
                  class="form-control"
                  id="usr_password"
                  formControlName="usr_password"
                  [class.is-invalid]="isFieldInvalid('usr_password')"
                />
                @if (isFieldInvalid('usr_password')) {
                  <div class="invalid-feedback">{{ getFieldError('usr_password') }}</div>
                }
              </div>

              <!-- Role and Person -->
              <div class="col-12 mb-3 mt-3">
                <h6 class="text-muted mb-3">Asignación</h6>
              </div>

              <div class="col-md-6 mb-3">
                <label for="role_id" class="form-label"
                  >Rol <span class="text-danger">*</span></label
                >
                <select
                  class="form-select"
                  id="role_id"
                  formControlName="role_id"
                  [class.is-invalid]="isFieldInvalid('role_id')"
                >
                  <option [value]="null">Seleccionar rol...</option>
                  @for (role of roles(); track role.id) {
                    <option [value]="role.id">{{ role.role_name }}</option>
                  }
                </select>
                @if (isFieldInvalid('role_id')) {
                  <div class="invalid-feedback">{{ getFieldError('role_id') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label for="person_id" class="form-label"
                  >Persona <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  id="person_id"
                  formControlName="person_id"
                  [class.is-invalid]="isFieldInvalid('person_id')"
                  placeholder="ID de la persona"
                />
                <small class="form-text text-muted">
                  Ingresa el ID de la persona del sistema
                </small>
                @if (isFieldInvalid('person_id')) {
                  <div class="invalid-feedback">{{ getFieldError('person_id') }}</div>
                }
              </div>

              <!-- Additional Settings -->
              <div class="col-12 mb-3 mt-3">
                <h6 class="text-muted mb-3">Configuración Adicional</h6>
              </div>

              <div class="col-md-6 mb-3">
                <label for="expiration_date" class="form-label">Fecha de Expiración</label>
                <input
                  type="date"
                  class="form-control"
                  id="expiration_date"
                  formControlName="expiration_date"
                />
                <small class="form-text text-muted">
                  Opcional - Fecha en que la cuenta expirará
                </small>
              </div>

              <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="usr_active"
                    [checked]="userForm.get('usr_active')?.value === 1"
                    (change)="onActiveChange($event)"
                  />
                  <label class="form-check-label" for="usr_active"> Usuario Activo </label>
                </div>

                <div class="form-check mt-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="is_generic"
                    [checked]="userForm.get('is_generic')?.value === 1"
                    (change)="onGenericChange($event)"
                  />
                  <label class="form-check-label" for="is_generic"> Usuario Genérico </label>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isSaving() || isLoading()">
            @if (isSaving()) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Guardando...
            } @else {
              @if (isEditMode()) {
                Actualizar Usuario
              } @else {
                Crear Usuario
              }
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
