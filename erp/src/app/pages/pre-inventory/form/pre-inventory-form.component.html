<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>Nuevo Conteo de Pre-Inventario</h2>
          <p class="text-muted mb-0">Crear un nuevo registro de conteo físico</p>
        </div>
        <button class="btn btn-secondary" routerLink="/pre-inventory">
          <mat-icon class="me-2">arrow_back</mat-icon>
          Volver
        </button>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <mat-icon class="me-2">add_circle</mat-icon>
            Datos del Conteo
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <!-- Material Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Material a Contar *</label>
              <div class="input-group mb-2">
                <span class="input-group-text">
                  <mat-icon>search</mat-icon>
                </span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Buscar material..."
                  [value]="materialSearchTerm()"
                  (input)="onMaterialSearch($event)">
              </div>
              @if (isLoadingMaterials()) {
                <div class="text-center py-2">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Cargando materiales...
                </div>
              } @else {
                <select
                  class="form-select"
                  formControlName="material_id"
                  [class.is-invalid]="form.get('material_id')?.invalid && form.get('material_id')?.touched">
                  <option [ngValue]="null">-- Seleccionar Material --</option>
                  @for (material of materials(); track material.id) {
                    <option [ngValue]="material.id">
                      {{ material.material_code }} - {{ material.material_name }}
                    </option>
                  }
                </select>
                @if (form.get('material_id')?.invalid && form.get('material_id')?.touched) {
                  <div class="invalid-feedback">
                    Debe seleccionar un material
                  </div>
                }
              }

              <!-- Selected Material Info -->
              @if (getSelectedMaterial(); as material) {
                <div class="alert alert-info mt-2 mb-0">
                  <div class="row">
                    <div class="col-md-4">
                      <small class="text-muted">Código:</small>
                      <div class="fw-bold">{{ material.material_code }}</div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted">Categoría:</small>
                      <div>{{ material.category_name || '-' }}</div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted">Unidad:</small>
                      <div>{{ material.unit_name || '-' }}</div>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Location Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Ubicación de Almacén *</label>
              @if (isLoadingLocations()) {
                <div class="text-center py-2">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Cargando ubicaciones...
                </div>
              } @else {
                <select
                  class="form-select"
                  formControlName="warehouse_location_id"
                  [class.is-invalid]="form.get('warehouse_location_id')?.invalid && form.get('warehouse_location_id')?.touched">
                  <option [ngValue]="null">-- Seleccionar Ubicación --</option>
                  @for (location of locations(); track location.id) {
                    <option [ngValue]="location.id">
                      {{ location.name }}
                    </option>
                  }
                </select>
                @if (form.get('warehouse_location_id')?.invalid && form.get('warehouse_location_id')?.touched) {
                  <div class="invalid-feedback">
                    Debe seleccionar una ubicación
                  </div>
                }
              }

              <!-- Selected Location Info -->
              @if (getSelectedLocation(); as location) {
                <div class="alert alert-secondary mt-2 mb-0">
                  <div class="d-flex align-items-center">
                    <mat-icon class="me-2">place</mat-icon>
                    <div>
                      <strong>{{ location.name }}</strong>
                      @if (location.alias) {
                        <div class="small text-muted">{{ location.alias }}</div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Count Date -->
            <div class="mb-4">
              <label class="form-label fw-bold">Fecha del Conteo</label>
              <input
                type="date"
                class="form-control"
                formControlName="count_date">
              <small class="text-muted">Si no se especifica, se usará la fecha actual</small>
            </div>

            <!-- Notes -->
            <div class="mb-4">
              <label class="form-label fw-bold">Notas</label>
              <textarea
                class="form-control"
                formControlName="notes"
                rows="3"
                placeholder="Observaciones adicionales (opcional)"></textarea>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2 pt-3 border-top">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="onCancel()"
                [disabled]="isSaving()">
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="form.invalid || isSaving()">
                @if (isSaving()) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <mat-icon class="me-2">save</mat-icon>
                Crear Conteo
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
      <div class="card border-info">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <mat-icon class="me-2">help</mat-icon>
            Información
          </h6>
        </div>
        <div class="card-body">
          <h6>¿Qué es un conteo de pre-inventario?</h6>
          <p class="small text-muted">
            El conteo de pre-inventario permite registrar el conteo físico de materiales en una ubicación específica del almacén.
          </p>

          <h6>Proceso:</h6>
          <ol class="small text-muted">
            <li>Crear el registro de conteo (este formulario)</li>
            <li>Realizar el conteo físico en el almacén</li>
            <li>Actualizar la cantidad contada en el sistema</li>
            <li>Si hay discrepancia, procesar el ajuste de inventario</li>
          </ol>

          <h6>Campos requeridos:</h6>
          <ul class="small text-muted mb-0">
            <li><strong>Material:</strong> El producto a contar</li>
            <li><strong>Ubicación:</strong> Donde se realizará el conteo</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
