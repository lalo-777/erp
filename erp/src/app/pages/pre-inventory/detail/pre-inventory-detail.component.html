<div class="container-fluid">
  @if (isLoading()) {
    <div class="text-center py-5">
      <app-loading-spinner></app-loading-spinner>
    </div>
  } @else if (record()) {
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2>Pre-Inventario {{ record()!.pre_inventory_number }}</h2>
            <p class="text-muted mb-0">Detalle y procesamiento de conteo físico</p>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" routerLink="/pre-inventory">
              <mat-icon class="me-2">arrow_back</mat-icon>
              Volver
            </button>
            @if (canCancel()) {
              <button class="btn btn-danger" (click)="onCancel()">
                <mat-icon class="me-2">cancel</mat-icon>
                Cancelar
              </button>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Status Badge -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex align-items-center gap-2">
          <h5 class="mb-0">Estado:</h5>
          <app-badge
            [color]="getStatusColor(record()!.status_id)"
            [icon]="getStatusIcon(record()!.status_id)"
            [text]="record()!.status_name || 'Desconocido'"
            size="lg">
          </app-badge>
          @if (record()!.adjusted) {
            <app-badge
              color="success"
              icon="verified"
              text="Ajustado"
              size="lg">
            </app-badge>
          }
        </div>
      </div>
    </div>

    <!-- Material and Location Info -->
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><mat-icon class="me-2">inventory_2</mat-icon>Material</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless mb-0">
              <tbody>
                <tr>
                  <th width="40%">Código:</th>
                  <td>{{ record()!.material_code }}</td>
                </tr>
                <tr>
                  <th>Nombre:</th>
                  <td>{{ record()!.material_name }}</td>
                </tr>
                <tr>
                  <th>Categoría:</th>
                  <td>{{ record()!.category_name }}</td>
                </tr>
                <tr>
                  <th>Unidad:</th>
                  <td>{{ record()!.unit_name }}</td>
                </tr>
                <tr>
                  <th>Costo Unitario:</th>
                  <td><strong>{{ formatCurrency(record()!.unit_cost) }}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><mat-icon class="me-2">place</mat-icon>Ubicación y Conteo</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless mb-0">
              <tbody>
                <tr>
                  <th width="40%">Ubicación:</th>
                  <td>{{ record()!.location_name }}</td>
                </tr>
                <tr>
                  <th>Fecha de Conteo:</th>
                  <td>{{ record()!.count_date | date:'medium' }}</td>
                </tr>
                <tr>
                  <th>Contado por:</th>
                  <td>{{ record()!.counted_by_name || '-' }}</td>
                </tr>
                <tr>
                  <th>Creado por:</th>
                  <td>{{ record()!.created_by_name }}</td>
                </tr>
                <tr>
                  <th>Fecha Creación:</th>
                  <td>{{ record()!.created_date | date:'medium' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Quantity and Discrepancy Info -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><mat-icon class="me-2">calculate</mat-icon>Cantidades y Discrepancia</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="quantity-box bg-light p-3 rounded">
                  <h6 class="text-muted mb-2">Cantidad Esperada</h6>
                  <h2 class="text-primary mb-0">{{ formatNumber(record()!.expected_quantity) }}</h2>
                  <small class="text-muted">{{ record()!.unit_name }}</small>
                </div>
              </div>

              <div class="col-md-3">
                <div class="quantity-box bg-light p-3 rounded">
                  <h6 class="text-muted mb-2">Cantidad Contada</h6>
                  @if (record()!.counted_quantity !== null && record()!.counted_quantity !== undefined) {
                    <h2 class="text-info mb-0">{{ formatNumber(record()!.counted_quantity!) }}</h2>
                    <small class="text-muted">{{ record()!.unit_name }}</small>
                  } @else {
                    <h2 class="text-muted mb-0">-</h2>
                    <small class="text-muted">Sin contar</small>
                  }
                </div>
              </div>

              <div class="col-md-3">
                <div class="quantity-box bg-light p-3 rounded">
                  <h6 class="text-muted mb-2">Discrepancia</h6>
                  @if (record()!.discrepancy !== null && record()!.discrepancy !== undefined) {
                    <h2 [class]="'mb-0 text-' + getDiscrepancyColor(record()!.discrepancy)">
                      {{ formatNumber(record()!.discrepancy!) }}
                    </h2>
                    <app-badge
                      [color]="getDiscrepancyColor(record()!.discrepancy)"
                      [text]="getDiscrepancyLabel(record()!.discrepancy)">
                    </app-badge>
                  } @else {
                    <h2 class="text-muted mb-0">-</h2>
                    <small class="text-muted">Pendiente</small>
                  }
                </div>
              </div>

              <div class="col-md-3">
                <div class="quantity-box bg-light p-3 rounded">
                  <h6 class="text-muted mb-2">Valor Discrepancia</h6>
                  @if (record()!.discrepancy_value !== null && record()!.discrepancy_value !== undefined) {
                    <h2 [class.text-success]="record()!.discrepancy_value! > 0"
                        [class.text-danger]="record()!.discrepancy_value! < 0"
                        class="mb-0">
                      {{ formatCurrency(record()!.discrepancy_value!) }}
                    </h2>
                    <small class="text-muted">Impacto financiero</small>
                  } @else {
                    <h2 class="text-muted mb-0">-</h2>
                    <small class="text-muted">Pendiente</small>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Physical Count Form -->
    @if (canUpdateCount()) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <mat-icon class="me-2">task</mat-icon>
                  Actualizar Conteo Físico
                </h5>
                <button
                  class="btn btn-sm btn-light"
                  (click)="onToggleCountForm()">
                  @if (showCountForm()) {
                    <mat-icon class="me-1">expand_less</mat-icon> Ocultar
                  } @else {
                    <mat-icon class="me-1">expand_more</mat-icon> Mostrar
                  }
                </button>
              </div>
            </div>
            @if (showCountForm()) {
              <div class="card-body">
                <form [formGroup]="countForm" (ngSubmit)="onUpdateCount()">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Cantidad Contada *</label>
                      <input
                        type="number"
                        class="form-control"
                        formControlName="counted_quantity"
                        step="0.01"
                        min="0"
                        placeholder="Ingrese la cantidad contada">
                      @if (countForm.get('counted_quantity')?.invalid && countForm.get('counted_quantity')?.touched) {
                        <div class="text-danger small mt-1">
                          La cantidad contada es requerida y debe ser mayor o igual a 0
                        </div>
                      }
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Notas</label>
                      <input
                        type="text"
                        class="form-control"
                        formControlName="notes"
                        placeholder="Observaciones adicionales">
                    </div>
                  </div>

                  <div class="d-flex justify-content-end gap-2">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      (click)="onToggleCountForm()"
                      [disabled]="isUpdating()">
                      Cancelar
                    </button>
                    <button
                      type="submit"
                      class="btn btn-warning"
                      [disabled]="countForm.invalid || isUpdating()">
                      @if (isUpdating()) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                      }
                      <mat-icon class="me-2">check_circle</mat-icon>
                      Actualizar Conteo
                    </button>
                  </div>
                </form>
              </div>
            }
          </div>
        </div>
      </div>
    }

    <!-- Process Adjustment -->
    @if (canProcessAdjustment()) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-danger">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0">
                <mat-icon class="me-2">warning</mat-icon>
                Procesar Ajuste de Inventario
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning mb-3">
                <mat-icon class="me-2">info</mat-icon>
                <strong>Atención:</strong> Al procesar este ajuste se creará una transacción de inventario y se actualizará el stock del material.
                Esta acción no se puede deshacer.
              </div>

              <div class="d-flex justify-content-end">
                <button
                  class="btn btn-danger btn-lg"
                  (click)="onProcessAdjustment()"
                  [disabled]="isProcessing()">
                  @if (isProcessing()) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  <mat-icon class="me-2">check_circle</mat-icon>
                  Procesar Ajuste
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Adjustment Info (if adjusted) -->
    @if (record()!.adjusted && record()!.adjustment_transaction_id) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <mat-icon class="me-2">check_circle</mat-icon>
                Información del Ajuste
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-success mb-0">
                <p class="mb-2">
                  <strong>Este registro ya fue ajustado.</strong>
                </p>
                <p class="mb-0">
                  Transacción de ajuste: <strong>{{ record()!.adjustment_transaction_number }}</strong>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Notes -->
    @if (record()!.notes) {
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><mat-icon class="me-2">note</mat-icon>Notas</h5>
            </div>
            <div class="card-body">
              <p class="mb-0">{{ record()!.notes }}</p>
            </div>
          </div>
        </div>
      </div>
    }
  }
</div>
