<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a routerLink="/warehouse">Almacén</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Stock por Ubicación</li>
            </ol>
          </nav>
          <h2>
            @if (location()) {
              <mat-icon class="me-2">business</mat-icon>{{ location()!.name }}
            } @else {
              Stock por Ubicación
            }
          </h2>
          @if (location()?.address) {
            <p class="text-muted mb-0">
              <mat-icon class="me-2">location_on</mat-icon>{{ location()!.address }}
            </p>
          }
        </div>
        <button class="btn btn-outline-secondary" routerLink="/warehouse">
          <mat-icon class="me-2">arrow_back</mat-icon>
          Volver
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  @if (stock().length > 0) {
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card border-primary">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Materiales</h6>
                <h3 class="mb-0">{{ stock().length }}</h3>
                <small class="text-muted">Diferentes materiales</small>
              </div>
              <div class="text-primary">
                <mat-icon class="fs-1">inventory_2</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card border-info">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Cantidad Total</h6>
                <h3 class="mb-0">{{ formatNumber(getTotalQuantity()) }}</h3>
                <small class="text-info">Unidades en stock</small>
              </div>
              <div class="text-info">
                <mat-icon class="fs-1">layers</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card border-success">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Valor Total</h6>
                <h3 class="mb-0">{{ formatCurrency(getTotalStockValue()) }}</h3>
                <small class="text-success">Valor de inventario</small>
              </div>
              <div class="text-success">
                <mat-icon class="fs-1">payments</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="card border-warning">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Stock Bajo</h6>
                <h3 class="mb-0">{{ getLowStockCount() }}</h3>
                <small class="text-warning">Materiales críticos</small>
              </div>
              <div class="text-warning">
                <mat-icon class="fs-1">warning</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Location Selector and Search -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Seleccionar Ubicación</label>
      <select
        class="form-select"
        [(ngModel)]="locationId"
        (change)="onLocationChange()"
      >
        @for (loc of allLocations(); track loc.id) {
          <option [value]="loc.id">{{ loc.name }}</option>
        }
      </select>
    </div>
    <div class="col-md-8">
      <label class="form-label">Buscar Material</label>
      <div class="input-group">
        <span class="input-group-text">
          <mat-icon>search</mat-icon>
        </span>
        <input
          type="text"
          class="form-control"
          placeholder="Buscar por código o nombre de material..."
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
        />
        <button class="btn btn-outline-secondary" type="button" (click)="onSearch()">Buscar</button>
      </div>
    </div>
  </div>

  <!-- Stock Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <mat-icon class="me-2">list</mat-icon>
            Materiales en Stock
          </h5>
        </div>
        <div class="card-body">
          @if (isLoading()) {
            <div class="text-center py-5">
              <app-loading-spinner></app-loading-spinner>
            </div>
          } @else if (stock().length === 0) {
            <app-empty-state
              icon="inventory_2"
              title="No hay stock"
              message="No se encontraron materiales en esta ubicación"
            ></app-empty-state>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Material</th>
                    <th>Categoría</th>
                    <th class="text-center">Estado</th>
                    <th class="text-end">Stock Ubicación</th>
                    <th class="text-end">Stock Total</th>
                    <th class="text-end">Stock Mínimo</th>
                    <th class="text-end">Costo Unit.</th>
                    <th class="text-end">Valor Total</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of stock(); track item.id) {
                    <tr [class.table-warning]="item.stock_status === 'low'"
                        [class.table-danger]="item.stock_status === 'critical' || item.stock_status === 'out_of_stock'">
                      <td>
                        <code>{{ item.material_code }}</code>
                      </td>
                      <td>
                        <strong>{{ item.material_name }}</strong>
                        <br>
                        <small class="text-muted">{{ item.unit_alias }}</small>
                      </td>
                      <td>{{ item.category_name }}</td>
                      <td class="text-center">
                        <span class="badge bg-{{ item.stock_status_color }}">
                          {{ item.stock_status_label }}
                        </span>
                      </td>
                      <td class="text-end">
                        <strong>{{ formatNumber(item.location_stock) }}</strong>
                      </td>
                      <td class="text-end">{{ formatNumber(item.total_stock) }}</td>
                      <td class="text-end">{{ formatNumber(item.minimum_stock) }}</td>
                      <td class="text-end">{{ formatCurrency(item.unit_cost) }}</td>
                      <td class="text-end">
                        <strong>{{ formatCurrency(item.stock_value || 0) }}</strong>
                      </td>
                    </tr>
                  }
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="8" class="text-end">Total:</th>
                    <th class="text-end">{{ formatCurrency(getTotalStockValue()) }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
